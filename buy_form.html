<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Konferencja Przedsiƒôbiorc√≥w</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="form_style.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500;700;800&family=DM+Serif+Display&display=swap">
</head>

<body>
    <div class="promo-bar">
        <div class="promo-content">
            <div class="promo-text">
                üéâ Tylko do ko≈Ñca Lutego!<br />
                Kod: <strong>LUTY</strong> - Najni≈ºsza cena! 50% zni≈ºki!
            </div>
            <div class="timer" id="timer">‚è±Ô∏è Pozosta≈Ço: ≈Åadowanie...</div>
        </div>
    </div>
    <div class="row">
        <!-- PASEK PROMOCYJNY -->

        <h1>Kup bilet</h1>

        <form id="buy">
            <label>Imiƒô i Nazwisko</label>
            <input name="fullName" required autocomplete="name" />

            <label>Email</label>
            <input name="email" type="email" required autocomplete="email" />

            <label>Numer telefonu</label>
            <input name="phone" required autocomplete="tel" />
            <label>Ulica</label>
            <input name="street" required />

            <label>Miasto</label>
            <input name="city" required />

            <label>Kod pocztowy</label>
            <input name="postalCode" required placeholder="00-000" />

            <label>Typ biletu</label>
            <select name="ticketType" required>
                <option value="premium">Premium (499 PLN)</option>
                <option value="biznesplus">Biznes Plus (599 PLN)</option>
                <option value="vip">VIP (999 PLN)</option>
                <option value="premiumonline">Premium Online (199 PLN)</option>
                <option value="biznesplusonline">Biznes Plus Online (349 PLN)</option>
            </select>

            <label>Ilo≈õƒá sztuk</label>
            <input name="quantity" type="number" min="1" max="20" value="1" required />

            <label>Kod promocyjny</label>
            <div class="promo-line">
                <input name="promoCode" id="promoCode" placeholder=" " />
                <button type="button" id="applyPromo" class="promo-apply-btn">Zastosuj</button>
            </div>
            <div id="promoHint" class="promo-hint"></div>

            <div class="order-summary" aria-live="polite">
                <span class="order-summary__label">Razem:</span>
                <span class="order-summary__value" id="orderTotal">‚Äî</span>
            </div>

            <button type="submit" class="payu-btn">
                <span class="payu-btn__brand">PayU</span>
                <span class="payu-btn__text">Przejd≈∫ do p≈Çatno≈õci</span>
            </button>

            <p id="msg"></p>
        </form>
    </div>

    <script>
        const msg = document.getElementById("msg");
        const form = document.getElementById("buy");

        // --- Dynamiczna kwota + promo apply ---
        const PRICE_GROSZE = {
            premium: 49900,
            biznesplus: 59900,
            vip: 99900,
            premiumonline: 19900,
            biznesplusonline: 34900,
        };

        const ticketSel = form.querySelector('select[name="ticketType"]');
        const qtyInput = form.querySelector('input[name="quantity"]');

        const promoInput = document.getElementById("promoCode");
        const applyPromoBtn = document.getElementById("applyPromo");
        const promoHintEl = document.getElementById("promoHint");
        const totalEl = document.getElementById("orderTotal");

        let promoApplied = false;
        let appliedCode = "";
        let discountFactor = 1;

        function formatPLNFromGrosze(grosze) {
            return (grosze / 100).toLocaleString("pl-PL", { style: "currency", currency: "PLN" });
        }

        function getQty() {
            const q = parseInt(qtyInput.value || "1", 10);
            return Math.max(1, Math.min(20, Number.isFinite(q) ? q : 1));
        }

        function getUnit() {
            const key = (ticketSel.value || "").toLowerCase();
            return PRICE_GROSZE[key] ?? 0;
        }

        function renderTotal() {
            const qty = getQty();
            const unit = getUnit();
            const unitAfter = Math.round(unit * (promoApplied ? discountFactor : 1));
            const total = unitAfter * qty;
            totalEl.textContent = unit ? formatPLNFromGrosze(total) : "‚Äî";
        }

        function clearPromo() {
            promoApplied = false;
            appliedCode = "";
            discountFactor = 1;
            promoHintEl.textContent = "";
            renderTotal();
        }

        promoInput.addEventListener("input", () => {
            if (promoApplied) clearPromo(); // zmiana kodu po zastosowaniu = reset
            applyPromoBtn.disabled = !promoInput.value.trim();
        });

        applyPromoBtn.addEventListener("click", () => {
            const code = (promoInput.value || "").trim().toLowerCase();

            // UWAGA: to MUSI byƒá sp√≥jne z backendem (patrz punkt 5).
            if (code === "luty") {
                promoApplied = true;
                appliedCode = "LUTY";
                discountFactor = 0.5;
                promoHintEl.textContent = "Kod zastosowany (-50%).";
            } else {
                promoApplied = false;
                appliedCode = "";
                discountFactor = 1;
                promoHintEl.textContent = "Nieprawid≈Çowy kod.";
            }
            renderTotal();
        });

        ticketSel.addEventListener("change", renderTotal);
        qtyInput.addEventListener("input", renderTotal);

        applyPromoBtn.disabled = !promoInput.value.trim();
        renderTotal();

        // --- Tw√≥j submit, tylko z jednƒÖ zmianƒÖ: wysy≈Çaj promoCode tylko gdy applied ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            msg.textContent = "Tworzƒô zam√≥wienie...";

            const fd = new FormData(form);
            const payload = Object.fromEntries(fd.entries());

            if (!promoApplied) payload.promoCode = "";
            else payload.promoCode = appliedCode || payload.promoCode;

            const res = await fetch("/api/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                const t = await res.text().catch(() => "");
                msg.textContent = `B≈ÇƒÖd tworzenia zam√≥wienia: ${res.status} ${t}`;
                return;
            }

            const data = await res.json();
            window.location.href = data.redirectUri;
        });
    </script>

    <script src="main.js" defer></script>
</body>

</html>